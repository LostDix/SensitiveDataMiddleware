# SensitiveDataMiddleware | –ó–∞—â–∏—Ç–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ Telegram —á–∞—Ç–∞—Ö
–≠—Ç–æ—Ç middleware –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Ö –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º –µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–µ—Ç–∞–ª—å–Ω–æ.
<br>
[–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤](https://else.com.ru "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤") -> https://else.com.ru/

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞
`SensitiveDataMiddleware` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤–∞–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö:

<ol> 
    <li>–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</li> 
    <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</li> 
    <li>–û–ø–æ–≤–µ—â–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ —Å –º–∞—Å–∫–∏—Ä–æ–≤–∫–æ–π –¥–∞–Ω–Ω—ã—Ö</li> 
    <li>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø—Ä–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</li> 
</ol>
    
## –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
```
  def __init__(self, bot):
    self.bot = bot
    super().__init__()
    logger.info("Initialized SensitiveDataMiddleware")
```


+ `bot` - —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π</li>
+ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ middleware</li>

## –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
```
  message = event.message or event.edited_message
  if not message:
    return await handler(event, data)

  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  if self._is_service_message(message):
    return await handler(event, data)

  if message.chat.type not in [ChatType.GROUP, ChatType.SUPERGROUP]:
    return await handler(event, data)
```
+ –†–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±—ã—á–Ω—ã–º–∏ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏</li>
+ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
+ –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö</li>

2. –ü–æ–∏—Å–∫ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```
  text = message.text or message.caption
  if not text:
    return await handler(event, data)

  sensitive_data = self._find_sensitive_data(text)
  if not sensitive_data:
    return await handler(event, data)
```
<ul>
    <li>–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—Å—Ç –∏ –ø–æ–¥–ø–∏—Å–∏ –∫ –º–µ–¥–∏–∞</li>
    <li>
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞:
        <ul>
            <li>–¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤</li>
            <li>–ë–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç</li>
            <li>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤</li>
            <li>–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤</li>
        </ul>
    </li>
</ul>

3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```
  reply_to_message_id = message.reply_to_message.message_id if message.reply_to_message else None

  try:
    await message.delete()
    logger.info(f"Deleted message with sensitive data in chat {message.chat.id}")
  except Exception as e:
    logger.error(f"Failed to delete message: {e}")
    return await handler(event, data)

  user_mention = message.from_user.mention_html() if message.from_user else "–ê–Ω–æ–Ω–∏–º"
  filtered_text = self._mask_sensitive_data(text)
```
+ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞</li>
+ –£–¥–∞–ª—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</li>
+ –ì–æ—Ç–æ–≤–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω—É—é –≤–µ—Ä—Å–∏—é —Ç–µ–∫—Å—Ç–∞ —Å –º–∞—Å–∫–∏—Ä–æ–≤–∫–æ–π –¥–∞–Ω–Ω—ã—Ö</li>

4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
```
  await self.bot.send_message(
    chat_id=message.chat.id,
    text=f"üîí {user_mention} –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω–µ–µ):\n{filtered_text}",
    parse_mode="HTML",
    reply_to_message_id=reply_to_message_id
  )
```
+ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</li>
+ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ü–µ–ø–æ—á–∫—É –æ–±—Å—É–∂–¥–µ–Ω–∏—è</li>
+ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HTML-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</li>

## –ú–µ—Ç–æ–¥—ã –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö
–ü–æ–∏—Å–∫ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
```
  def _find_sensitive_data(self, text: str) -> list:
    """–ù–∞—Ö–æ–¥–∏—Ç –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ"""
    # –¢–µ–ª–µ—Ñ–æ–Ω—ã (—Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ)
    phones = re.findall(r'(?:\+|\b)[\d\(\)\- ]{7,}\d', text)
    
    # –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã
    cards = re.findall(r'\b(?:\d[ \-]?){15,18}\d\b', text)
    
    # –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏
    wallets = re.findall(r'\b(?:\d{11,16}|[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})\b', text)
    
    # –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ –∞–¥—Ä–µ—Å–∞
    crypto = re.findall(
        r'\b(?:0x[a-fA-F0-9]{40}|[13][a-km-zA-HJ-NP-Z1-9]{25,34}|'
        r'[LM3][a-km-zA-HJ-NP-Z1-9]{26,33}|'
        r'D{1}[5-9A-HJ-NP-U]{1}[1-9A-HJ-NP-Za-km-z]{32}|'
        r'[Xx][0-9A-Za-z]{33}|[A-Za-z0-9]{35,44})\b',
        text
    )
    
    return phones + cards + wallets + crypto
```

–ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
```
  def _mask_sensitive_data(self, text: str) -> str:
    """–ó–∞–º–µ–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ ***"""
    # –¢–µ–ª–µ—Ñ–æ–Ω—ã: –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–µ 3 —Ü–∏—Ñ—Ä—ã
    text = re.sub(r'(?:\+|\b)([\d\(\)\- ]{7,}\d)',
                  lambda m: m.group(1)[:3] + '*' * (len(m.group(1)) - 3), text)
    
    # –ö–∞—Ä—Ç—ã: –ø–µ—Ä–≤—ã–µ 4 –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã
    text = re.sub(r'\b(?:\d[ \-]?){15,18}\d\b',
                  lambda m: m.group(0)[:4] + '*' * (len(m.group(0)) - 8) + m.group(0)[-4:], text)
    
    # –ö–æ—à–µ–ª—å–∫–∏: –ø–µ—Ä–≤—ã–µ 3 —Å–∏–º–≤–æ–ª–∞
    text = re.sub(r'\b(?:\d{11,16}|[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})\b',
                  lambda m: m.group(0)[:3] + '*' * (len(m.group(0)) - 3), text)
    
    # –ö—Ä–∏–ø—Ç–æ–∞–¥—Ä–µ—Å–∞: –ø–µ—Ä–≤—ã–µ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–∏–º–≤–æ–ª–∞
    text = re.sub(
        r'\b(?:0x[a-fA-F0-9]{40}|[13][a-km-zA-HJ-NP-Z1-9]{25,34}|'
        r'[LM3][a-km-zA-HJ-NP-Z1-9]{26,33}|'
        r'D{1}[5-9A-HJ-NP-U]{1}[1-9A-HJ-NP-Za-km-z]{32}|'
        r'[Xx][0-9A-Za-z]{33}|[A-Za-z0-9]{35,44})\b',
        lambda m: m.group(0)[:4] + '*' * (len(m.group(0)) - 8) + m.group(0)[-4:],
        text
    )
    
    return text
```

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
Middleware –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è:

+ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤ —Å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ–º —Ä–∞–±–æ—á–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤</li>
+ –ü—É–±–ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤ —Å –±–æ–ª—å—à–∏–º –ø–æ—Ç–æ–∫–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π</li>
+ –§–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –±–æ—Ç–æ–≤</li>
+ –ß–∞—Ç–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</li>
+ –õ—é–±—ã—Ö –≥—Ä—É–ø–ø, –≥–¥–µ –≤–∞–∂–Ω–∞ –∑–∞—â–∏—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</li>

## –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è
–í—ã –º–æ–∂–µ—Ç–µ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:

<ol>
    <li>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
        <ul>
            <li>–ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</li>
            <li>–ù–æ–º–µ—Ä–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤</li>
            <li>–°–ª—É–∂–µ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</li>
        </ul>
    </li>
    <li>–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏:
        <blockquote>
        # –ü—Ä–∏–º–µ—Ä: –ø–æ–ª–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ email <br>
        text = re.sub(r'[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}', '[email —Å–∫—Ä—ã—Ç]', text)
        </blockquote>
    </li>
    <li>–í–≤–µ—Å—Ç–∏ –±–µ–ª—ã–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
    <li>–î–æ–±–∞–≤–∏—Ç—å –≤–µ–¥–µ–Ω–∏–µ –ª–æ–≥–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</li>
</ol>

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π middleware –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω—É—é –∑–∞—â–∏—Ç—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ Telegram-—á–∞—Ç–∞—Ö, —Å–æ—á–µ—Ç–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –º–æ–¥–µ—Ä–∞—Ü–∏—é —Å –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.
<br>
<blockquote>
<b>–ù—É–∂–Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –≤–∞—à–µ–º Telegram-—Å–æ–æ–±—â–µ—Å—Ç–≤–µ?</b>

–ö–æ–º–∞–Ω–¥–∞ ELSE (https://else.com.ru/) —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è:<br>

‚úÖ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö<br>
‚úÖ –ö–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥ –≤–∞—à –±–∏–∑–Ω–µ—Å<br>
‚úÖ –ì–∏–±–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–æ–¥ –≤–∞—à–∏ –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∏<br>
‚úÖ –ë—ã—Å—Ç—Ä—É—é –∏ —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É<br>

–ó–∞–∫–∞–∂–∏—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –±–æ—Ç–∞ –Ω–∞ else.com.ru –∏ –∑–∞—â–∏—Ç–∏—Ç–µ —Å–≤–æ—é –ø–µ—Ä–µ–ø–∏—Å–∫—É!<br>
[–°–æ–∑–¥–∞–Ω–∏–µ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤](https://else.com.ru "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤") -> https://else.com.ru/
</blockquote>